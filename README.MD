# Há»‡ Thá»‘ng Äá»“ng Bá»™ Cháº¥m CÃ´ng ERPNext

Há»‡ thá»‘ng Ä‘á»“ng bá»™ tá»± Ä‘á»™ng giá»¯a mÃ¡y cháº¥m cÃ´ng sinh tráº¯c há»c vÃ  ERPNext vá»›i kháº£ nÄƒng bypass thá»i gian vÃ  auto-restart.

## ğŸ“ Cáº¥u TrÃºc ThÆ° Má»¥c

```
biometric-attendance-sync-tool/
â”œâ”€â”€ README.MD                                    # TÃ i liá»‡u chÃ­nh (tiáº¿ng Viá»‡t)
â”œâ”€â”€ README_SERVICE.md                            # TÃ i liá»‡u dá»‹ch vá»¥ (tiáº¿ng Anh)
â”œâ”€â”€ local_config.py                              # Cáº¥u hÃ¬nh tÄ©nh + cáº¥u hÃ¬nh Ä‘á»™ng bypass
â”œâ”€â”€ erpnext_sync_all.py                          # Dá»‹ch vá»¥ chÃ­nh Ä‘iá»u phá»‘i
â”œâ”€â”€ sync_log_from_device_to_erpnext.py          # Sync log cháº¥m cÃ´ng tá»« thiáº¿t bá»‹ Ä‘áº¿n ERPNext
â”œâ”€â”€ sync_user_info_from_erpnext_to_device.py    # Sync thÃ´ng tin nhÃ¢n viÃªn tá»« ERPNext Ä‘áº¿n thiáº¿t bá»‹
â”œâ”€â”€ sync_user_info_state.py                     # Quáº£n lÃ½ tráº¡ng thÃ¡i sync user info
â”œâ”€â”€ erpnext_api_client.py                       # Client API ERPNext
â”œâ”€â”€ test_finger_mapping_consistency.py          # Test script kiá»ƒm tra tÃ­nh nháº¥t quÃ¡n finger mapping
â”œâ”€â”€ start_erpnext_sync_all_manual.sh            # Script khá»Ÿi Ä‘á»™ng service thá»§ cÃ´ng
â”œâ”€â”€ stop_erpnext_sync_all_manual.sh             # Script dá»«ng service thá»§ cÃ´ng (force kill)
â”œâ”€â”€ status_erpnext_sync_all_manual.sh           # Script kiá»ƒm tra tráº¡ng thÃ¡i service
â”œâ”€â”€ test_paths.sh                               # Script test Ä‘Æ°á»ng dáº«n
â”œâ”€â”€ requirements.txt                            # Danh sÃ¡ch dependencies
â”œâ”€â”€ set_up_requirement.sh                       # Script cÃ i Ä‘áº·t dependencies vÃ  phÃ¢n quyá»n
â””â”€â”€ logs/                                       # ThÆ° má»¥c chá»©a log
    â”œâ”€â”€ service.log                             # Log dá»‹ch vá»¥ chÃ­nh
    â”œâ”€â”€ service_error.log                       # Log lá»—i dá»‹ch vá»¥
    â”œâ”€â”€ logs.log                                # Log tá»•ng quÃ¡t
    â”œâ”€â”€ error.log                               # Log lá»—i
    â”œâ”€â”€ attendance_success_log_*.log            # Log thÃ nh cÃ´ng theo thiáº¿t bá»‹
    â”œâ”€â”€ attendance_failed_log_*.log             # Log tháº¥t báº¡i theo thiáº¿t bá»‹
    â”œâ”€â”€ user_id_ignored_log.txt                 # Log user bá»‹ bá» qua
    â”œâ”€â”€ error_duplicate.log                     # Log lá»—i trÃ¹ng láº·p
    â””â”€â”€ sync_from_erpnext_to_device/           # Log sync user info
```

## âš™ï¸ Thuáº­t ToÃ¡n Hoáº¡t Äá»™ng

### ğŸ”„ Chu Ká»³ ChÃ­nh (Má»—i 3 phÃºt)

```mermaid
graph TD
    A[Khá»Ÿi Ä‘á»™ng Service] --> B[Load Cáº¥u hÃ¬nh Äá»™ng]
    B --> C[Kiá»ƒm tra Bypass Time]
    C --> D{Bypass Log Sync?}
    D -->|CÃ³| E[Bá» qua Sync Log]
    D -->|KhÃ´ng| F[Thá»±c hiá»‡n Sync Log tá»« Device Ä‘áº¿n ERPNext]
    E --> G{Bypass User Sync?}
    F --> G
    G -->|CÃ³| H[Bá» qua Sync User Info]
    G -->|KhÃ´ng| I[Thá»±c hiá»‡n Sync User Info tá»« ERPNext Ä‘áº¿n Device]
    H --> J[Chá» 3 phÃºt]
    I --> K{Bypass Clear Left?}
    K -->|CÃ³| L[Bá» qua xÃ³a template nghá»‰ viá»‡c]
    K -->|KhÃ´ng| M[XÃ³a template nhÃ¢n viÃªn nghá»‰ viá»‡c]
    L --> J
    M --> J
    J --> B
```

### ğŸ¯ Chi Tiáº¿t CÃ¡c BÆ°á»›c

**1. Sync Log tá»« Device Ä‘áº¿n ERPNext**
- Káº¿t ná»‘i vá»›i tá»«ng mÃ¡y cháº¥m cÃ´ng
- Láº¥y dá»¯ liá»‡u cháº¥m cÃ´ng má»›i
- Gá»­i Ä‘áº¿n ERPNext API
- Xá»­ lÃ½ lá»—i vÃ  retry
- Ghi log thÃ nh cÃ´ng/tháº¥t báº¡i

**2. Sync User Info tá»« ERPNext Ä‘áº¿n Device**
- Láº¥y danh sÃ¡ch nhÃ¢n viÃªn cÃ³ thay Ä‘á»•i
- **Normalize tÃªn tiáº¿ng Viá»‡t**: `Nguyá»…n VÄƒn A` â†’ `Nguyen Van A` (device compatibility)
- PhÃ¢n loáº¡i: Active, Left, Changed
- Sync template vÃ¢n tay
- XÃ³a template nhÃ¢n viÃªn nghá»‰ viá»‡c (náº¿u khÃ´ng bá»‹ bypass)

**3. Time-based Bypass Logic**
- **07:30-07:55**: Bypass táº¥t cáº£ (giá» vÃ o ca sÃ¡ng)
- **17:00-17:30**: Bypass táº¥t cáº£ (giá» tan ca chiá»u)  
- **00:00-22:00**: Bypass xÃ³a template nghá»‰ viá»‡c

## ğŸš€ CÃ¡ch CÃ i Äáº·t vÃ  Cháº¡y

### BÆ°á»›c 1: CÃ i Ä‘áº·t Dependencies vÃ  PhÃ¢n quyá»n
```bash
# CÃ i Ä‘áº·t dependencies trong virtual environment vÃ  set permissions
./set_up_requirement.sh
```

### BÆ°á»›c 2: Kiá»ƒm tra ÄÆ°á»ng dáº«n
```bash
# Kiá»ƒm tra tá»± Ä‘á»™ng detect paths
./test_paths.sh
```

### BÆ°á»›c 3: Khá»Ÿi Ä‘á»™ng Service Thá»§ cÃ´ng
```bash
# Khá»Ÿi Ä‘á»™ng service thá»§ cÃ´ng (khÃ´ng cáº§n sudo)
./start_erpnext_sync_all_manual.sh
```

### BÆ°á»›c 4: Kiá»ƒm tra Service hoáº¡t Ä‘á»™ng
```bash
# Kiá»ƒm tra tráº¡ng thÃ¡i service
./status_erpnext_sync_all_manual.sh

# Dá»«ng service (force kill táº¥t cáº£ processes)
./stop_erpnext_sync_all_manual.sh
```

### BÆ°á»›c 5: Theo dÃµi Logs
```bash
# Xem log realtime
tail -f logs/service.log

# Xem táº¥t cáº£ logs
tail -f logs/*.log
```

## ğŸ“Š CÃ¡ch Kiá»ƒm tra Service

### ğŸ” Kiá»ƒm tra Tráº¡ng ThÃ¡i Service

```bash
# Tráº¡ng thÃ¡i tá»•ng quan vá»›i chi tiáº¿t Ä‘áº§y Ä‘á»§
./status_erpnext_sync_all_manual.sh

# Kiá»ƒm tra process Ä‘ang cháº¡y
ps aux | grep 'erpnext_sync_all.py'

# Kiá»ƒm tra PID file
cat erpnext_sync_all.pid

# Kiá»ƒm tra connectivity Ä‘áº¿n devices
ping 10.0.1.48
ping 10.0.1.50
```

### ğŸ“ˆ Theo dÃµi Hoáº¡t Ä‘á»™ng

```bash
# Theo dÃµi log service real-time
tail -f logs/service.log

# Theo dÃµi log errors
tail -f logs/error.log

# Theo dÃµi táº¥t cáº£ logs
tail -f logs/*.log

# Xem logs trong ngÃ y
grep "$(date +%Y-%m-%d)" logs/service.log

# Kiá»ƒm tra device connectivity logs
tail -f logs/attendance_success_log_*.log
```

### âš¡ Test Manual

```bash
# Test cáº¥u hÃ¬nh
venv/bin/python3 erpnext_sync_all.py --test-config

# Xem status cáº¥u hÃ¬nh  
venv/bin/python3 erpnext_sync_all.py --status

# Test 15 giÃ¢y (dá»«ng service trÆ°á»›c)
./stop_erpnext_sync_all_manual.sh
timeout 15 venv/bin/python3 erpnext_sync_all.py

# Cháº¡y manual Ä‘á»ƒ debug
./stop_erpnext_sync_all_manual.sh
venv/bin/python3 erpnext_sync_all.py
```

## ğŸ“‹ CÃ¡ch Xem Log

### ğŸ—‚ï¸ CÃ¡c File Log ChÃ­nh

1. **Service Log**
   ```bash
   # Log chÃ­nh cá»§a service
   tail -f logs/service.log
   
   # Log lá»—i service
   tail -f logs/service_error.log
   ```

2. **Application Log**  
   ```bash
   # Log tá»•ng quÃ¡t
   tail -f logs/logs.log
   
   # Log lá»—i á»©ng dá»¥ng
   tail -f logs/error.log
   ```

3. **Sync Log**
   ```bash
   # Log thÃ nh cÃ´ng theo tá»«ng mÃ¡y
   tail -f logs/attendance_success_log_Machine_8.log
   tail -f logs/attendance_success_log_Machine_10.log
   
   # Log tháº¥t báº¡i theo tá»«ng mÃ¡y
   tail -f logs/attendance_failed_log_Machine_8.log
   tail -f logs/attendance_failed_log_Machine_10.log
   
   # Log user bá»‹ ignore
   tail -f logs/user_id_ignored_log.txt
   
   # Log duplicate timestamp
   tail -f logs/error_duplicate.log
   ```

4. **User Sync Log**
   ```bash
   # Log sync user info
   tail -f logs/sync_from_erpnext_to_device/sync_to_device.log
   ```

## ğŸ‘† Finger Mapping Utilities

Há»‡ thá»‘ng sá»­ dá»¥ng **standardized finger mapping** Ä‘á»ƒ Ä‘áº£m báº£o tÃ­nh nháº¥t quÃ¡n giá»¯a finger index vÃ  finger name:

### **Finger Index Mapping:**
```
0: Left Little    5: Right Thumb
1: Left Ring      6: Right Index  
2: Left Middle    7: Right Middle
3: Left Index     8: Right Ring
4: Left Thumb     9: Right Little
```

### **Available Functions:**
- `local_config.get_finger_name(finger_index)` - Chuyá»ƒn index thÃ nh name
- `local_config.get_finger_index(finger_name)` - Chuyá»ƒn name thÃ nh index
- `local_config.validate_finger_index(index)` - Validate finger index
- `local_config.validate_finger_name(name)` - Validate finger name

### **Consistency Testing:**
```bash
# Test tÃ­nh nháº¥t quÃ¡n finger mapping toÃ n bá»™ codebase
venv/bin/python3 test_finger_mapping_consistency.py
```

**ğŸ¯ Táº¥t cáº£ modules Ä‘á»u sá»­ dá»¥ng finger mapping tá»« local_config.py Ä‘á»ƒ Ä‘áº£m báº£o tÃ­nh nháº¥t quÃ¡n!**

## ğŸ”¤ Xá»­ LÃ½ TÃªn Tiáº¿ng Viá»‡t

Há»‡ thá»‘ng **luÃ´n luÃ´n** normalize tÃªn tiáº¿ng Viá»‡t khi sync tá»« ERPNext Ä‘áº¿n device Ä‘á»ƒ Ä‘áº£m báº£o tÆ°Æ¡ng thÃ­ch:

### **VÃ­ dá»¥ Name Normalization:**
```
Nguyá»…n VÄƒn A        â†’ Nguyen Van A
Tráº§n Thá»‹ BÃ­ch Tháº£o  â†’ Tran Thi Bich Thao  
LÃª HoÃ ng Äá»©c        â†’ Le Hoang Duc
Pháº¡m Quá»³nh NhÆ°      â†’ Pham Quynh Nhu
```

### **LÃ½ do:**
- âœ… **Device compatibility**: TrÃ¡nh lá»—i hiá»ƒn thá»‹ trÃªn mÃ¡y cháº¥m cÃ´ng
- âœ… **Character encoding**: TrÃ¡nh conflict vá»›i device firmware
- âœ… **Consistency**: Äá»“ng nháº¥t trÃªn táº¥t cáº£ devices
- âœ… **Reliability**: Giáº£m thiá»ƒu lá»—i sync do special characters

### **Implementation:**
- Sá»­ dá»¥ng thÆ° viá»‡n `unidecode` 
- Tá»± Ä‘á»™ng fallback náº¿u khÃ´ng cÃ³ unidecode
- Apply cho táº¥t cáº£ employee names khi sync Ä‘áº¿n device

### ğŸ” Log Analysis Commands

```bash
# Äáº¿m sá»‘ láº§n sync thÃ nh cÃ´ng hÃ´m nay
grep "$(date +%Y-%m-%d)" logs/attendance_success_log_*.log | wc -l

# Xem errors trong 24h qua
grep "ERROR" logs/error.log | tail -50

# Kiá»ƒm tra cycle frequency
grep "CYCLE #" logs/service.log | tail -10

# Xem bypass status
grep "Cáº¥u HÃ¬nh Äá»™ng" logs/service.log | tail -5

# TÃ¬m duplicate errors
grep "DUPLICATE" logs/error_duplicate.log | tail -20

# Performance monitoring  
grep "completed.*in.*s" logs/service.log | tail -10
```

## âš™ï¸ Cáº¥u HÃ¬nh Bypass Time

### ğŸ“ Chá»‰nh sá»­a Bypass Periods trong `local_config.py`

```python
# Bypass sync log tá»« device Ä‘áº¿n ERPNext (giá» rush)
sync_log_by_pass_period = [
    {"start": "07:30", "end": "07:55", "reason": "Morning rush"},
    {"start": "17:00", "end": "17:30", "reason": "Evening rush"}
]

# Bypass sync user info tá»« ERPNext Ä‘áº¿n device (giá» rush)  
sync_user_info_by_pass_period = [
    {"start": "07:30", "end": "07:55", "reason": "Morning rush"},
    {"start": "17:00", "end": "17:30", "reason": "Evening rush"}
]

# Bypass xÃ³a template nghá»‰ viá»‡c (chá»‰ cho phÃ©p sau 22:00)
clear_left_user_template_by_pass_period = [
    {"start": "00:00", "end": "22:00", "reason": "Working hours"}
]
```

### ğŸ›ï¸ Feature Toggles

```python
# Báº­t/táº¯t chá»©c nÄƒng sync user info
ENABLE_SYNC_USER_INFO_FROM_ERPNEXT_TO_DEVICE = True

# Báº­t/táº¯t chá»©c nÄƒng xÃ³a template nghá»‰ viá»‡c
ENABLE_CLEAR_LEFT_USER_TEMPLATES = True

# Cháº¿ Ä‘á»™ sync: 'auto', 'full', 'changed'
SYNC_USER_INFO_MODE = 'auto'

# Safety net: Sá»‘ giá» quÃ©t ngÆ°á»£c khi máº¥t last_sync state
SYNC_CHANGED_HOURS_BACK = 24
```

### ğŸ“ Chi tiáº¿t SYNC_CHANGED_HOURS_BACK

**Má»¥c Ä‘Ã­ch**: Safety net (lÆ°á»›i an toÃ n) khi máº¥t file state

**Hoáº¡t Ä‘á»™ng bÃ¬nh thÆ°á»ng (99.9% trÆ°á»ng há»£p):**
- Service sync tá»« `last_sync` (3 phÃºt trÆ°á»›c)
- SYNC_CHANGED_HOURS_BACK **KHÃ”NG** Ä‘Æ°á»£c sá»­ dá»¥ng

**Chá»‰ sá»­ dá»¥ng khi kháº©n cáº¥p:**
- ğŸ”¥ File state bá»‹ máº¥t/corrupt (`logs/sync_from_erpnext_to_device/last_sync_global.json`)
- ğŸ”¥ Láº§n Ä‘áº§u cháº¡y sau khi xÃ³a logs
- ğŸ”¥ Service crash nhiá»u ngÃ y
- ğŸ”¥ Manual reset state

**VÃ­ dá»¥ logic:**
```python
# Æ¯u tiÃªn: DÃ¹ng last_sync tá»« file state (3 phÃºt trÆ°á»›c)
since_datetime = self.sync_state.get_last_sync() or \
                # Fallback: QuÃ©t ngÆ°á»£c 24h thay vÃ¬ full sync toÃ n bá»™ DB
                (datetime.now() - timedelta(hours=24))
```

**Lá»£i Ã­ch**: TrÃ¡nh full sync toÃ n bá»™ database khi cÃ³ sá»± cá»‘

## ğŸ› ï¸ Quáº£n lÃ½ Service Manual

### â–¶ï¸ Start/Stop/Status

```bash
# Khá»Ÿi Ä‘á»™ng service (vá»›i conflict detection)
./start_erpnext_sync_all_manual.sh

# Dá»«ng service (force kill táº¥t cáº£ processes)
./stop_erpnext_sync_all_manual.sh

# Kiá»ƒm tra tráº¡ng thÃ¡i service
./status_erpnext_sync_all_manual.sh

# Khá»Ÿi Ä‘á»™ng láº¡i (stop + start)
./stop_erpnext_sync_all_manual.sh && ./start_erpnext_sync_all_manual.sh
```

### ğŸ”§ Configuration Management

```bash
# Chá»‰nh sá»­a cáº¥u hÃ¬nh
nano local_config.py

# Service sáº½ tá»± Ä‘á»™ng reload config má»—i 3 phÃºt
# KhÃ´ng cáº§n restart - cáº¥u hÃ¬nh Ä‘á»™ng sáº½ tá»± Ã¡p dá»¥ng

# Hoáº·c restart Ä‘á»ƒ Ã¡p dá»¥ng ngay
./stop_erpnext_sync_all_manual.sh
./start_erpnext_sync_all_manual.sh
```

### ğŸ”§ Setup vÃ  Permissions

```bash
# Setup láº¡i dependencies vÃ  permissions
./set_up_requirement.sh

# Manual permissions fix
chmod +x *.sh
chmod +x *.py
chmod 755 logs/
```

## ğŸš¨ Xá»­ LÃ½ Lá»—i ThÆ°á»ng Gáº·p

### 1. Service khÃ´ng khá»Ÿi Ä‘á»™ng Ä‘Æ°á»£c
```bash
# Kiá»ƒm tra tráº¡ng thÃ¡i chi tiáº¿t
./status_erpnext_sync_all_manual.sh

# Kiá»ƒm tra file paths
./test_paths.sh

# Test cáº¥u hÃ¬nh
venv/bin/python3 erpnext_sync_all.py --test-config

# Kiá»ƒm tra logs
tail -f logs/error.log
```

### 2. Káº¿t ná»‘i device tháº¥t báº¡i
```bash
# Kiá»ƒm tra IP device trong local_config.py
# Kiá»ƒm tra network connectivity
ping 10.0.1.48
ping 10.0.1.50

# Status script tá»± Ä‘á»™ng test connectivity
./status_erpnext_sync_all_manual.sh

# Xem log káº¿t ná»‘i device
grep "Device.*not reachable" logs/service.log
```

### 3. ERPNext API errors
```bash
# Kiá»ƒm tra API credentials trong local_config.py  
# Test API connection
curl -X GET "http://10.0.1.21/api/resource/Employee" \
  -H "Authorization: token 7c5bab33922d7f6:2d379dbe1ef33ab"

# Xem API errors
grep "ERPNext API" logs/error.log
```

### 4. Performance Issues
```bash
# Kiá»ƒm tra thá»i gian cycle
grep "completed.*in.*s" logs/service.log | tail -10

# Monitor resource usage
htop -p $(pgrep -f erpnext_sync_all)

# Kiá»ƒm tra disk space cho logs
du -h logs/
```

## ğŸ“ Support

- **Kiá»ƒm tra tráº¡ng thÃ¡i**: `./status_erpnext_sync_all_manual.sh`
- **Xem log chi tiáº¿t**: `tail -f logs/service.log`
- **Test cáº¥u hÃ¬nh**: `venv/bin/python3 erpnext_sync_all.py --test-config`  
- **Debug manual**: `./stop_erpnext_sync_all_manual.sh && venv/bin/python3 erpnext_sync_all.py`
- **Path detection**: `./test_paths.sh`
- **Setup láº¡i**: `./set_up_requirement.sh`

---
