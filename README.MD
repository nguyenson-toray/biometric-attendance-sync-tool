# Há»‡ Thá»‘ng Äá»“ng Bá»™ Cháº¥m CÃ´ng ERPNext

Há»‡ thá»‘ng Ä‘á»“ng bá»™ tá»± Ä‘á»™ng giá»¯a mÃ¡y cháº¥m cÃ´ng sinh tráº¯c há»c vÃ  ERPNext vá»›i kháº£ nÄƒng bypass thá»i gian vÃ  tÃ­nh nÄƒng re-sync.

## ğŸ“ Cáº¥u TrÃºc ThÆ° Má»¥c

```
biometric-attendance-sync-tool/
â”œâ”€â”€ README.MD                                    # TÃ i liá»‡u chÃ­nh
â”œâ”€â”€ local_config.py                              # Cáº¥u hÃ¬nh há»‡ thá»‘ng
â”œâ”€â”€ erpnext_sync_all.py                          # Service chÃ­nh
â”œâ”€â”€ sync_log_from_device_to_erpnext.py          # Sync log cháº¥m cÃ´ng tá»« thiáº¿t bá»‹ Ä‘áº¿n ERPNext
â”œâ”€â”€ sync_user_info_from_erpnext_to_device.py    # Sync thÃ´ng tin nhÃ¢n viÃªn tá»« ERPNext Ä‘áº¿n thiáº¿t bá»‹
â”œâ”€â”€ start_erpnext_sync_all_manual.sh            # Script khá»Ÿi Ä‘á»™ng service
â”œâ”€â”€ stop_erpnext_sync_all_manual.sh             # Script dá»«ng service
â”œâ”€â”€ status_erpnext_sync_all_manual.sh           # Script kiá»ƒm tra tráº¡ng thÃ¡i
â”œâ”€â”€ set_up_requirement.sh                       # Script cÃ i Ä‘áº·t dependencies
â””â”€â”€ logs/                                       # ThÆ° má»¥c chá»©a log files
```

## ğŸš€ CÃ¡ch Sá»­ Dá»¥ng

### BÆ°á»›c 1: CÃ i Ä‘áº·t
```bash
# CÃ i Ä‘áº·t dependencies vÃ  phÃ¢n quyá»n
./set_up_requirement.sh
```

### BÆ°á»›c 2: Khá»Ÿi Ä‘á»™ng Service
```bash
# Khá»Ÿi Ä‘á»™ng service
./start_erpnext_sync_all_manual.sh

# Kiá»ƒm tra tráº¡ng thÃ¡i
./status_erpnext_sync_all_manual.sh

# Dá»«ng service
./stop_erpnext_sync_all_manual.sh
```

### BÆ°á»›c 3: Theo dÃµi Logs
```bash
# Theo dÃµi log chÃ­nh
tail -f logs/logs.log

# Theo dÃµi log lá»—i
tail -f logs/error.log
```

## âš™ï¸ Cáº¥u HÃ¬nh ChÃ­nh

Chá»‰nh sá»­a file `local_config.py`:

### ğŸ”§ Cáº¥u hÃ¬nh CÆ¡ báº£n
```python
# ThÃ´ng tin ERPNext
ERPNEXT_URL = 'http://10.0.1.21'
ERPNEXT_API_KEY = '7c5bab33922d7f6'
ERPNEXT_API_SECRET = '2d379dbe1ef33ab'

# Táº§n suáº¥t Ä‘á»“ng bá»™ (phÃºt)
PULL_FREQUENCY = 3

# Danh sÃ¡ch mÃ¡y cháº¥m cÃ´ng (hiá»‡n táº¡i: Machine_1 Ä‘áº¿n Machine_7)
devices = [
    {'device_id':'Machine_1','ip':'10.0.1.41', 'punch_direction': None, 'clear_from_device_on_fetch': False, 'latitude':0.0000,'longitude':0.0000},
    {'device_id':'Machine_2','ip':'10.0.1.42', 'punch_direction': None, 'clear_from_device_on_fetch': False, 'latitude':0.0000,'longitude':0.0000},
    # ... Machine_3 to Machine_7 (10.0.1.43-47)
]

# Master device cho sync fingerprints
devices_master = {'device_id':'Machine_1','ip':'10.0.1.41', ...}

# User IDs bá»‹ bá» qua (táº¡p vá»¥)
user_id_inorged = ['55','58','161','623','916','920','3000','3001','3002','6004','6005']
```

### ğŸ”„ TÃ­nh nÄƒng Re-sync

#### **Manual Re-sync**
**Má»¥c Ä‘Ã­ch**: Bá»• sung cÃ¡c log cháº¥m cÃ´ng cÃ²n thiáº¿u trong khoáº£ng thá»i gian cá»¥ thá»ƒ.

```python
# Báº­t re-sync cho khoáº£ng thá»i gian cá»¥ thá»ƒ
re_sync_data_date_range = ['20250907','20250907']  # ['YYYYMMDD','YYYYMMDD']

# Táº¯t re-sync (cháº¿ Ä‘á»™ normal)
re_sync_data_date_range = []
```

**CÃ¡ch hoáº¡t Ä‘á»™ng**:
- âœ… **KhÃ´ng xÃ³a** dá»¯ liá»‡u cÃ³ sáºµn trong ERPNext
- âœ… Sync **Táº¤T Cáº¢ logs** tá»« mÃ¡y cháº¥m cÃ´ng trong khoáº£ng thá»i gian
- âœ… **Tá»± Ä‘á»™ng bá» qua duplicate** (khÃ´ng táº¡o error log)
- âœ… Chá»‰ thÃªm cÃ¡c logs **cÃ²n thiáº¿u** vÃ o ERPNext

**Workflow sá»­ dá»¥ng**:
1. Set `re_sync_data_date_range = ['20250907','20250907']`
2. Cháº¡y service: `./start_erpnext_sync_all_manual.sh`
3. Sau khi hoÃ n thÃ nh, set `re_sync_data_date_range = []`

#### **ğŸŒ™ End-of-Day Auto Re-sync** â­ **NEW**
**Má»¥c Ä‘Ã­ch**: Tá»± Ä‘á»™ng re-sync toÃ n bá»™ logs trong ngÃ y vÃ o thá»i Ä‘iá»ƒm cuá»‘i ngÃ y Ä‘á»ƒ Ä‘áº£m báº£o khÃ´ng thiáº¿u dá»¯ liá»‡u.

```python
# Cáº¥u hÃ¬nh End-of-Day Re-sync
ENABLE_END_OF_DAY_RESYNC = True          # Báº­t/táº¯t tÃ­nh nÄƒng
END_OF_DAY_RESYNC_HOUR = 23              # Giá» thá»±c hiá»‡n (0-23)
END_OF_DAY_RESYNC_MINUTE = 30            # PhÃºt thá»±c hiá»‡n (0-59)
END_OF_DAY_RESYNC_WINDOW_MINUTES = 10    # Cá»­a sá»• thá»i gian Â±5 phÃºt
END_OF_DAY_RESYNC_LOG_FILE = 'logs/logs_resync.log'  # Log riÃªng cho re-sync
```

**ğŸš€ TÃ­nh nÄƒng**:
- âœ… **Tá»± Ä‘á»™ng cháº¡y** má»—i ngÃ y vÃ o thá»i Ä‘iá»ƒm cáº¥u hÃ¬nh (máº·c Ä‘á»‹nh 23:30)
- âœ… **Re-sync toÃ n bá»™ logs** trong ngÃ y hiá»‡n táº¡i tá»« táº¥t cáº£ mÃ¡y cháº¥m cÃ´ng
- âœ… **Bá» qua táº¥t cáº£ bypass periods** Ä‘á»ƒ Ä‘áº£m báº£o sync hoÃ n chá»‰nh
- âœ… **Log riÃªng biá»‡t** trong `logs/logs_resync.log`
- âœ… **Filter duplicate errors** tá»± Ä‘á»™ng, chá»‰ giá»¯ log quan trá»ng
- âœ… **Comprehensive logging** vá»›i status chi tiáº¿t vÃ  duration

**ğŸ” CÃ¡ch hoáº¡t Ä‘á»™ng**:
1. **Every cycle**: Service kiá»ƒm tra thá»i gian hiá»‡n táº¡i
2. **At target time** (vÃ­ dá»¥ 23:25-23:35): Trigger end-of-day re-sync
3. **Auto setup**: Tá»± Ä‘á»™ng set `re_sync_data_date_range = [today, today]`
4. **Force sync**: Bá» qua táº¥t cáº£ bypass logic, force káº¿t ná»‘i táº¥t cáº£ devices
5. **Auto restore**: KhÃ´i phá»¥c cáº¥u hÃ¬nh gá»‘c sau khi hoÃ n thÃ nh

**ğŸ“‹ Log Monitoring**:
```bash
# Theo dÃµi end-of-day re-sync
tail -f logs/logs_resync.log

# Kiá»ƒm tra lá»‹ch sá»­ re-sync
grep "END-OF-DAY RE-SYNC CYCLE" logs/logs_resync.log
```

### â° Cáº¥u hÃ¬nh Bypass Time (trong local_config.py)
```python
# Bypass sync log (giá» rush) - hiá»‡n táº¡i: Táº®T
sync_log_by_pass_period = [
    # {"start": "07:30", "end": "07:55", "reason": "Morning rush - employees clocking in"},
    # {"start": "17:00", "end": "17:30", "reason": "Evening rush - employees clocking out"}
]

# Bypass sync user info (giá» rush) - hiá»‡n táº¡i: Táº®T
sync_user_info_by_pass_period = [
    # {"start": "07:30", "end": "07:55", "reason": "Morning rush - avoid device conflicts"},
    # {"start": "17:00", "end": "17:30", "reason": "Evening rush - avoid device conflicts"}
]

# Bypass clear left templates - hiá»‡n táº¡i: Táº®T
clear_left_user_template_by_pass_period = []
```

### ğŸ›ï¸ Feature Toggles (trong local_config.py)
```python
# Báº­t/táº¯t sync thÃ´ng tin nhÃ¢n viÃªn - hiá»‡n táº¡i: Táº®T
ENABLE_SYNC_USER_INFO_FROM_ERPNEXT_TO_DEVICE = False

# Báº­t/táº¯t clear left templates - hiá»‡n táº¡i: Táº®T  
ENABLE_CLEAR_LEFT_USER_TEMPLATES = False

# Cháº¿ Ä‘á»™ sync: 'auto', 'full', 'changed'
SYNC_USER_INFO_MODE = 'auto'
SYNC_CHANGED_HOURS_BACK = 24

# End-of-Day Auto Re-sync (NEW) - hiá»‡n táº¡i: Báº¬T
ENABLE_END_OF_DAY_RESYNC = True
END_OF_DAY_RESYNC_HOUR = 23
END_OF_DAY_RESYNC_MINUTE = 30
```

## ğŸ“Š GiÃ¡m sÃ¡t Há»‡ thá»‘ng

### ğŸ” Kiá»ƒm tra Service
```bash
# Tráº¡ng thÃ¡i tá»•ng quan
./status_erpnext_sync_all_manual.sh

# Kiá»ƒm tra process
ps aux | grep 'erpnext_sync_all.py'

# Test cáº¥u hÃ¬nh vÃ  bypass status
python3 erpnext_sync_all.py --test-config
python3 -c "import local_config; print(local_config.get_bypass_status())"
```

### ğŸ“ˆ Log Analysis
```bash
# Theo dÃµi hoáº¡t Ä‘á»™ng real-time
tail -f logs/logs.log

# Theo dÃµi end-of-day re-sync (NEW)
tail -f logs/logs_resync.log

# Äáº¿m sá»‘ láº§n sync thÃ nh cÃ´ng hÃ´m nay
grep "$(date +%Y-%m-%d)" logs/attendance_success_log_*.log | wc -l

# Xem lá»—i gáº§n Ä‘Ã¢y
grep "ERROR" logs/error.log | tail -20

# Kiá»ƒm tra re-sync mode
grep "Re-sync mode" logs/logs.log | tail -5

# Kiá»ƒm tra lá»‹ch sá»­ end-of-day re-sync (NEW)
grep "END-OF-DAY RE-SYNC CYCLE" logs/logs_resync.log

# Thá»‘ng kÃª end-of-day re-sync (NEW)
grep "COMPLETED" logs/logs_resync.log | grep -E "(SUCCESSFULLY|WITH ERRORS)"
```

## ğŸ“‹ CÃ¡c File Log Quan trá»ng

```bash
# Log chÃ­nh
logs/logs.log                              # Tá»•ng quÃ¡t
logs/error.log                             # Lá»—i há»‡ thá»‘ng
logs/logs_resync.log                       # End-of-day re-sync (NEW)

# Log theo mÃ¡y cháº¥m cÃ´ng
logs/attendance_success_log_Machine_*.log  # ThÃ nh cÃ´ng theo mÃ¡y
logs/attendance_failed_log_Machine_*.log   # Tháº¥t báº¡i theo mÃ¡y

# Log Ä‘áº·c biá»‡t
logs/user_id_inorged_log.txt               # User bá»‹ bá» qua
logs/error_duplicate.log                   # Duplicate (normal mode)
```

## ğŸš¨ Xá»­ LÃ½ Lá»—i ThÆ°á»ng Gáº·p

### 1. Service khÃ´ng khá»Ÿi Ä‘á»™ng
```bash
# Kiá»ƒm tra chi tiáº¿t
./status_erpnext_sync_all_manual.sh

# Test cáº¥u hÃ¬nh
venv/bin/python3 erpnext_sync_all.py --test-config

# Xem log lá»—i
tail -f logs/error.log
```

### 2. Káº¿t ná»‘i mÃ¡y cháº¥m cÃ´ng tháº¥t báº¡i
```bash
# Test network
ping 10.0.1.41
ping 10.0.1.42

# Xem log connectivity
grep "Device.*not reachable" logs/logs.log
```

### 3. ERPNext API lá»—i
```bash
# Test API
curl -X GET "http://10.0.1.21/api/resource/Employee" \
  -H "Authorization: token 7c5bab33922d7f6:2d379dbe1ef33ab"

# Xem API errors  
grep "ERPNext API" logs/error.log
```

## ğŸ”¤ Xá»­ LÃ½ TÃªn Tiáº¿ng Viá»‡t

Há»‡ thá»‘ng tá»± Ä‘á»™ng normalize tÃªn tiáº¿ng Viá»‡t khi sync tá»« ERPNext Ä‘áº¿n mÃ¡y cháº¥m cÃ´ng:

```
Nguyá»…n VÄƒn A    â†’ Nguyen Van A
Tráº§n Thá»‹ BÃ­ch   â†’ Tran Thi Bich  
LÃª HoÃ ng Äá»©c    â†’ Le Hoang Duc
```

**LÃ½ do**: Äáº£m báº£o tÆ°Æ¡ng thÃ­ch vá»›i firmware mÃ¡y cháº¥m cÃ´ng.

## ğŸ“ Há»— trá»£

### Commands Há»¯u Ã­ch
```bash
# Kiá»ƒm tra tráº¡ng thÃ¡i
./status_erpnext_sync_all_manual.sh

# Debug manual
./stop_erpnext_sync_all_manual.sh
venv/bin/python3 erpnext_sync_all.py

# Setup láº¡i
./set_up_requirement.sh
```

---

**ğŸ¯ LÆ°u Ã½**: 
- Service tá»± Ä‘á»™ng reload config má»—i 5 phÃºt
- Manual re-sync: DÃ¹ng Ä‘á»ƒ bá»• sung logs thiáº¿u, set `[]` sau khi xong
- End-of-day auto re-sync: Tá»± Ä‘á»™ng cháº¡y má»—i ngÃ y Ä‘á»ƒ Ä‘áº£m báº£o Ä‘áº§y Ä‘á»§ dá»¯ liá»‡u
- Bypass time: TrÃ¡nh conflict trong giá» rush
- Log monitoring: Theo dÃµi `logs/logs_resync.log` Ä‘á»ƒ xem káº¿t quáº£ end-of-day re-sync