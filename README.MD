# H·ªá Th·ªëng ƒê·ªìng B·ªô Ch·∫•m C√¥ng ERPNext

H·ªá th·ªëng ƒë·ªìng b·ªô t·ª± ƒë·ªông gi·ªØa m√°y ch·∫•m c√¥ng sinh tr·∫Øc h·ªçc v√† ERPNext v·ªõi kh·∫£ nƒÉng bypass th·ªùi gian v√† t√≠nh nƒÉng re-sync.

## üìÅ C·∫•u Tr√∫c Th∆∞ M·ª•c

```
biometric-attendance-sync-tool/
‚îú‚îÄ‚îÄ README.MD                                    # T√†i li·ªáu ch√≠nh
‚îú‚îÄ‚îÄ local_config.py                              # C·∫•u h√¨nh h·ªá th·ªëng
‚îú‚îÄ‚îÄ erpnext_sync_all.py                          # Service ch√≠nh
‚îú‚îÄ‚îÄ sync_log_from_device_to_erpnext.py          # Sync log ch·∫•m c√¥ng t·ª´ thi·∫øt b·ªã ƒë·∫øn ERPNext
‚îú‚îÄ‚îÄ sync_user_info_from_erpnext_to_device.py    # Sync th√¥ng tin nh√¢n vi√™n t·ª´ ERPNext ƒë·∫øn thi·∫øt b·ªã
‚îú‚îÄ‚îÄ start_erpnext_sync_all_manual.sh            # Script kh·ªüi ƒë·ªông service
‚îú‚îÄ‚îÄ stop_erpnext_sync_all_manual.sh             # Script d·ª´ng service
‚îú‚îÄ‚îÄ status_erpnext_sync_all_manual.sh           # Script ki·ªÉm tra tr·∫°ng th√°i
‚îú‚îÄ‚îÄ set_up_requirement.sh                       # Script c√†i ƒë·∫∑t dependencies
‚îî‚îÄ‚îÄ logs/                                       # Th∆∞ m·ª•c ch·ª©a log files
```

## üöÄ C√°ch S·ª≠ D·ª•ng

### B∆∞·ªõc 1: C√†i ƒë·∫∑t
```bash
# C√†i ƒë·∫∑t dependencies v√† ph√¢n quy·ªÅn
./set_up_requirement.sh
```

### B∆∞·ªõc 2: Kh·ªüi ƒë·ªông Service
```bash
# Kh·ªüi ƒë·ªông service
./start_erpnext_sync_all_manual.sh

# Ki·ªÉm tra tr·∫°ng th√°i
./status_erpnext_sync_all_manual.sh

# D·ª´ng service
./stop_erpnext_sync_all_manual.sh
```

### B∆∞·ªõc 3: Theo d√µi Logs
```bash
# Theo d√µi log ch√≠nh
tail -f logs/logs.log

# Theo d√µi log l·ªói
tail -f logs/error.log
```

## ‚öôÔ∏è C·∫•u H√¨nh Ch√≠nh

Ch·ªânh s·ª≠a file `local_config.py`:

### üîß C·∫•u h√¨nh C∆° b·∫£n
```python
# Th√¥ng tin ERPNext
ERPNEXT_URL = 'http://10.0.1.21'
ERPNEXT_API_KEY = '7c5bab33922d7f6'
ERPNEXT_API_SECRET = '2d379dbe1ef33ab'

# T·∫ßn su·∫•t ƒë·ªìng b·ªô (ph√∫t)
PULL_FREQUENCY = 3

# Danh s√°ch m√°y ch·∫•m c√¥ng (hi·ªán t·∫°i: Machine_1 ƒë·∫øn Machine_7)
devices = [
    {'device_id':'Machine_1','ip':'10.0.1.41', 'punch_direction': None, 'clear_from_device_on_fetch': False, 'latitude':0.0000,'longitude':0.0000},
    {'device_id':'Machine_2','ip':'10.0.1.42', 'punch_direction': None, 'clear_from_device_on_fetch': False, 'latitude':0.0000,'longitude':0.0000},
    # ... Machine_3 to Machine_7 (10.0.1.43-47)
]

# Master device cho sync fingerprints
devices_master = {'device_id':'Machine_1','ip':'10.0.1.41', ...}

# User IDs b·ªã b·ªè qua (t·∫°p v·ª•)
user_id_inorged = ['55','58','161','623','916','920','3000','3001','3002','6004','6005']
```

### üîÑ T√≠nh nƒÉng Re-sync

#### **Manual Re-sync**
**M·ª•c ƒë√≠ch**: B·ªï sung c√°c log ch·∫•m c√¥ng c√≤n thi·∫øu trong kho·∫£ng th·ªùi gian c·ª• th·ªÉ.

```python
# B·∫≠t re-sync cho kho·∫£ng th·ªùi gian c·ª• th·ªÉ
re_sync_data_date_range = ['20250907','20250907']  # ['YYYYMMDD','YYYYMMDD']

# T·∫Øt re-sync (ch·∫ø ƒë·ªô normal)
re_sync_data_date_range = []
```

**C√°ch ho·∫°t ƒë·ªông**:
- ‚úÖ **Kh√¥ng x√≥a** d·ªØ li·ªáu c√≥ s·∫µn trong ERPNext
- ‚úÖ Sync **T·∫§T C·∫¢ logs** t·ª´ m√°y ch·∫•m c√¥ng trong kho·∫£ng th·ªùi gian
- ‚úÖ **T·ª± ƒë·ªông b·ªè qua duplicate** (kh√¥ng t·∫°o error log)
- ‚úÖ Ch·ªâ th√™m c√°c logs **c√≤n thi·∫øu** v√†o ERPNext

**Workflow s·ª≠ d·ª•ng**:
1. Set `re_sync_data_date_range = ['20250907','20250907']`
2. Ch·∫°y service: `./start_erpnext_sync_all_manual.sh`
3. Sau khi ho√†n th√†nh, set `re_sync_data_date_range = []`

#### **üåô End-of-Day Auto Re-sync** ‚≠ê **NEW**
**M·ª•c ƒë√≠ch**: T·ª± ƒë·ªông re-sync to√†n b·ªô logs trong ng√†y v√†o th·ªùi ƒëi·ªÉm cu·ªëi ng√†y ƒë·ªÉ ƒë·∫£m b·∫£o kh√¥ng thi·∫øu d·ªØ li·ªáu.

```python
# C·∫•u h√¨nh End-of-Day Re-sync
ENABLE_END_OF_DAY_RESYNC = True          # B·∫≠t/t·∫Øt t√≠nh nƒÉng
END_OF_DAY_RESYNC_HOUR = 23              # Gi·ªù th·ª±c hi·ªán (0-23)
END_OF_DAY_RESYNC_MINUTE = 30            # Ph√∫t th·ª±c hi·ªán (0-59)
END_OF_DAY_RESYNC_WINDOW_MINUTES = 10    # C·ª≠a s·ªï th·ªùi gian ¬±5 ph√∫t
END_OF_DAY_RESYNC_LOG_FILE = 'logs/logs_resync.log'  # Log ri√™ng cho re-sync
```

**üöÄ T√≠nh nƒÉng**:
- ‚úÖ **T·ª± ƒë·ªông ch·∫°y** m·ªói ng√†y v√†o th·ªùi ƒëi·ªÉm c·∫•u h√¨nh (m·∫∑c ƒë·ªãnh 23:30)
- ‚úÖ **Re-sync to√†n b·ªô logs** trong ng√†y hi·ªán t·∫°i t·ª´ t·∫•t c·∫£ m√°y ch·∫•m c√¥ng
- ‚úÖ **B·ªè qua t·∫•t c·∫£ bypass periods** ƒë·ªÉ ƒë·∫£m b·∫£o sync ho√†n ch·ªânh
- ‚úÖ **Log ri√™ng bi·ªát** trong `logs/logs_resync.log`
- ‚úÖ **Filter duplicate errors** t·ª± ƒë·ªông, ch·ªâ gi·ªØ log quan tr·ªçng
- ‚úÖ **Comprehensive logging** v·ªõi status chi ti·∫øt v√† duration

**üîç C√°ch ho·∫°t ƒë·ªông**:
1. **Every cycle**: Service ki·ªÉm tra th·ªùi gian hi·ªán t·∫°i
2. **At target time** (v√≠ d·ª• 23:25-23:35): Trigger end-of-day re-sync
3. **Auto setup**: T·ª± ƒë·ªông set `re_sync_data_date_range = [today, today]`
4. **Force sync**: B·ªè qua t·∫•t c·∫£ bypass logic, force k·∫øt n·ªëi t·∫•t c·∫£ devices
5. **Auto restore**: Kh√¥i ph·ª•c c·∫•u h√¨nh g·ªëc sau khi ho√†n th√†nh

**üìã Log Monitoring**:
```bash
# Theo d√µi end-of-day re-sync
tail -f logs/logs_resync.log

# Ki·ªÉm tra l·ªãch s·ª≠ re-sync
grep "END-OF-DAY RE-SYNC CYCLE" logs/logs_resync.log
```

### ‚è∞ C·∫•u h√¨nh Bypass Time (trong local_config.py)
```python
# Bypass sync log (gi·ªù rush) - hi·ªán t·∫°i: T·∫ÆT
sync_log_by_pass_period = [
    # {"start": "07:30", "end": "07:55", "reason": "Morning rush - employees clocking in"},
    # {"start": "17:00", "end": "17:30", "reason": "Evening rush - employees clocking out"}
]

# Bypass sync user info (gi·ªù rush) - hi·ªán t·∫°i: T·∫ÆT
sync_user_info_by_pass_period = [
    # {"start": "07:30", "end": "07:55", "reason": "Morning rush - avoid device conflicts"},
    # {"start": "17:00", "end": "17:30", "reason": "Evening rush - avoid device conflicts"}
]
```

### üéõÔ∏è Feature Toggles (trong local_config.py)
```python
# B·∫≠t/t·∫Øt sync th√¥ng tin nh√¢n vi√™n - hi·ªán t·∫°i: T·∫ÆT
ENABLE_SYNC_USER_INFO_FROM_ERPNEXT_TO_DEVICE = False

# B·∫≠t/t·∫Øt clear left templates - hi·ªán t·∫°i: B·∫¨T
ENABLE_CLEAR_LEFT_USER_TEMPLATES_ON_DEVICES = True  # Clear from devices (once per day)
CLEAR_LEFT_USER_TEMPLATES_RELIEVING_DELAY_DAYS = 7  # Wait N days after relieving before clearing (today >= relieving_date + 7 days)
ENABLE_DELETE_LEFT_USER_ON_DEVICES_AFTER_RELIEVING_DAYS = 1400  # Permanently delete users after N days (0 = disabled, PRIORITY 1 - checked FIRST)
ENABLE_CLEAR_LEFT_USER_TEMPLATES_ON_ERPNEXT = False  # Delete from database
PROCESSED_LEFT_EMPLOYEES_FILE = 'logs/processed_left_employees.json'  # Track processed employees (skip on subsequent runs)

# Ch·∫ø ƒë·ªô sync: 'auto', 'full', 'changed'
SYNC_USER_INFO_MODE = 'auto'
SYNC_CHANGED_HOURS_BACK = 24

# End-of-Day Auto Re-sync (NEW) - hi·ªán t·∫°i: B·∫¨T
ENABLE_END_OF_DAY_RESYNC = True
END_OF_DAY_RESYNC_HOUR = 23
END_OF_DAY_RESYNC_MINUTE = 30
```

## üìä Gi√°m s√°t H·ªá th·ªëng

### üîç Ki·ªÉm tra Service
```bash
# Tr·∫°ng th√°i t·ªïng quan
./status_erpnext_sync_all_manual.sh

# Ki·ªÉm tra process
ps aux | grep 'erpnext_sync_all.py'

# Test c·∫•u h√¨nh v√† bypass status
python3 erpnext_sync_all.py --test-config
python3 -c "import local_config; print(local_config.get_bypass_status())"
```

### üìà Log Analysis
```bash
# Theo d√µi ho·∫°t ƒë·ªông real-time
tail -f logs/logs.log

# Theo d√µi end-of-day re-sync (NEW)
tail -f logs/logs_resync.log

# ƒê·∫øm s·ªë l·∫ßn sync th√†nh c√¥ng h√¥m nay
grep "$(date +%Y-%m-%d)" logs/attendance_success_log_*.log | wc -l

# Xem l·ªói g·∫ßn ƒë√¢y
grep "ERROR" logs/error.log | tail -20

# Ki·ªÉm tra re-sync mode
grep "Re-sync mode" logs/logs.log | tail -5

# Ki·ªÉm tra l·ªãch s·ª≠ end-of-day re-sync (NEW)
grep "END-OF-DAY RE-SYNC CYCLE" logs/logs_resync.log

# Th·ªëng k√™ end-of-day re-sync (NEW)
grep "COMPLETED" logs/logs_resync.log | grep -E "(SUCCESSFULLY|WITH ERRORS)"
```

## üìã C√°c File Log Quan tr·ªçng

```bash
# Log ch√≠nh
logs/logs.log                              # T·ªïng qu√°t
logs/error.log                             # L·ªói h·ªá th·ªëng
logs/logs_resync.log                       # End-of-day re-sync (NEW)

# Log theo m√°y ch·∫•m c√¥ng
logs/attendance_success_log_Machine_*.log  # Th√†nh c√¥ng theo m√°y
logs/attendance_failed_log_Machine_*.log   # Th·∫•t b·∫°i theo m√°y

# Log ƒë·∫∑c bi·ªát
logs/user_id_inorged_log.txt               # User b·ªã b·ªè qua
logs/error_duplicate.log                   # Duplicate (normal mode)
```

## üö® X·ª≠ L√Ω L·ªói Th∆∞·ªùng G·∫∑p

### 1. Service kh√¥ng kh·ªüi ƒë·ªông
```bash
# Ki·ªÉm tra chi ti·∫øt
./status_erpnext_sync_all_manual.sh

# Test c·∫•u h√¨nh
venv/bin/python3 erpnext_sync_all.py --test-config

# Xem log l·ªói
tail -f logs/error.log
```

### 2. K·∫øt n·ªëi m√°y ch·∫•m c√¥ng th·∫•t b·∫°i
```bash
# Test network
ping 10.0.1.41
ping 10.0.1.42

# Xem log connectivity
grep "Device.*not reachable" logs/logs.log
```

### 3. ERPNext API l·ªói
```bash
# Test API
curl -X GET "http://10.0.1.21/api/resource/Employee" \
  -H "Authorization: token 7c5bab33922d7f6:2d379dbe1ef33ab"

# Xem API errors  
grep "ERPNext API" logs/error.log
```

## üî§ X·ª≠ L√Ω T√™n Ti·∫øng Vi·ªát

H·ªá th·ªëng t·ª± ƒë·ªông normalize t√™n ti·∫øng Vi·ªát khi sync t·ª´ ERPNext ƒë·∫øn m√°y ch·∫•m c√¥ng:

```
Nguy·ªÖn VƒÉn A    ‚Üí Nguyen Van A
Tr·∫ßn Th·ªã B√≠ch   ‚Üí Tran Thi Bich  
L√™ Ho√†ng ƒê·ª©c    ‚Üí Le Hoang Duc
```

**L√Ω do**: ƒê·∫£m b·∫£o t∆∞∆°ng th√≠ch v·ªõi firmware m√°y ch·∫•m c√¥ng.

## üìû H·ªó tr·ª£

### Commands H·ªØu √≠ch
```bash
# Ki·ªÉm tra tr·∫°ng th√°i
./status_erpnext_sync_all_manual.sh

# Debug manual
./stop_erpnext_sync_all_manual.sh
venv/bin/python3 erpnext_sync_all.py

# Setup l·∫°i
./set_up_requirement.sh
```

---

**üéØ L∆∞u √Ω**: 
- Service t·ª± ƒë·ªông reload config m·ªói 5 ph√∫t
- Manual re-sync: D√πng ƒë·ªÉ b·ªï sung logs thi·∫øu, set `[]` sau khi xong
- End-of-day auto re-sync: T·ª± ƒë·ªông ch·∫°y m·ªói ng√†y ƒë·ªÉ ƒë·∫£m b·∫£o ƒë·∫ßy ƒë·ªß d·ªØ li·ªáu
- Bypass time: Tr√°nh conflict trong gi·ªù rush
- Log monitoring: Theo d√µi `logs/logs_resync.log` ƒë·ªÉ xem k·∫øt qu·∫£ end-of-day re-sync

**üö´ Kill processs **: 
- ps aux | grep erpnext_sync_all | grep -v grep
frappe    208657  1.3  0.1 116204 34176 pts/5    Sl+  16:37   0:00 ./venv/bin/python3 ./erpnext_sync_all.py
- kill -9 208657