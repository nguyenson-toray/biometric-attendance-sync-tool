# Sync All From Master Device To Other Devices

Äá»“ng bá»™ dá»¯ liá»‡u vÃ¢n tay tá»« thiáº¿t bá»‹ master Ä‘áº¿n táº¥t cáº£ cÃ¡c thiáº¿t bá»‹ khÃ¡c trong há»‡ thá»‘ng.

## ğŸ“‹ MÃ´ táº£ chá»©c nÄƒng

Há»‡ thá»‘ng nÃ y Ä‘á»c táº¥t cáº£ user vÃ  dá»¯ liá»‡u vÃ¢n tay tá»« thiáº¿t bá»‹ master, sau Ä‘Ã³ Ä‘á»“ng bá»™ Ä‘áº¿n cÃ¡c thiáº¿t bá»‹ target Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a trong config. Sá»­ dá»¥ng threading Ä‘á»ƒ tÄƒng tá»‘c Ä‘á»™ xá»­ lÃ½.

### âš¡ TÃ­nh nÄƒng chÃ­nh:
- âœ… **Äá»c tá»« Master Device**: Scan táº¥t cáº£ users vÃ  fingerprints tá»« thiáº¿t bá»‹ master
- âœ… **Multi-threading**: Äá»“ng bá»™ Ä‘á»“ng thá»i Ä‘áº¿n nhiá»u thiáº¿t bá»‹ target  
- âœ… **Template Validation**: Chá»‰ sync fingerprints há»£p lá»‡ (size > 0)
- âœ… **Progress Tracking**: Hiá»ƒn thá»‹ tiáº¿n Ä‘á»™ vÃ  káº¿t quáº£ chi tiáº¿t
- âœ… **Error Handling**: Xá»­ lÃ½ lá»—i vÃ  retry logic
- âœ… **Comprehensive Logging**: Log chi tiáº¿t vá»›i mÃ u sáº¯c vÃ  timestamps

## ğŸ—‚ï¸ Files liÃªn quan

```
biometric-attendance-sync-tool/
â”œâ”€â”€ sync_all_from_master_device_to_other_devices.py    # Core sync script
â”œâ”€â”€ sync_all_from_master_device_to_other_devices.sh    # Shell script vá»›i logging
â”œâ”€â”€ local_config.py                                    # Configuration
â””â”€â”€ logs/                                              # Log directory
    â”œâ”€â”€ sync_master_to_devices.log                     # Main log
    â””â”€â”€ sync_master_to_devices_error.log              # Error log
```

## âš™ï¸ Cáº¥u hÃ¬nh

### local_config.py
```python
# Master device - nguá»“n dá»¯ liá»‡u vÃ¢n tay
devices_master = {
    'device_id': 'Machine_8',
    'ip': '10.0.1.48',
    'punch_direction': None,
    'clear_from_device_on_fetch': False,
    'latitude': 0.0,
    'longitude': 0.0
}

# Target devices - Ä‘Ã­ch Ä‘á»ƒ sync Ä‘áº¿n
devices = [
    {'device_id': 'Machine_1', 'ip': '10.0.1.41', ...},
    {'device_id': 'Machine_10', 'ip': '10.0.1.50', ...},
    # ... thÃªm cÃ¡c mÃ¡y khÃ¡c
]
```

## ğŸš€ CÃ¡ch sá»­ dá»¥ng

### 1. Shell Script (Khuyáº¿n khÃ­ch)

```bash
# Sync táº¥t cáº£ users tá»« master Ä‘áº¿n target devices
./sync_all_from_master_device_to_other_devices.sh

# Sync vá»›i verbose output
./sync_all_from_master_device_to_other_devices.sh -v

# Sync vá»›i giá»›i háº¡n sá»‘ users (testing)
./sync_all_from_master_device_to_other_devices.sh --limit 10

# Test connectivity
./sync_all_from_master_device_to_other_devices.sh test

# Xem tráº¡ng thÃ¡i sync
./sync_all_from_master_device_to_other_devices.sh status
```

### 2. Python Script trá»±c tiáº¿p

```bash
# Sync táº¥t cáº£ users
python sync_all_from_master_device_to_other_devices.py

# Sync vá»›i giá»›i háº¡n
python sync_all_from_master_device_to_other_devices.py --limit 5
```

## ğŸ“Š Quy trÃ¬nh xá»­ lÃ½

### 1. Äá»c dá»¯ liá»‡u tá»« Master Device
```
ğŸ” Scanning master device for users with fingerprints...
ğŸ‘¥ Found 901 total users on master device
  Progress: 0/901
  âœ… 161: Truong Thi My Hoa (4 fingerprints)
  âœ… 295: Nguyen Thi Thuong (2 fingerprints)
ğŸ“Š Found 200+ users with fingerprints
```

### 2. Äá»“ng bá»™ Ä‘áº¿n Target Devices
```
ğŸ“¤ Syncing 200 users to 2 target devices...
Progress: 1/200 - 161: Truong Thi My Hoa (4 fingerprints)
  âœ… Synced to 2/2 devices: Machine_1, Machine_10
Progress: 2/200 - 295: Nguyen Thi Thuong (2 fingerprints)
  âŒ Failed to sync to any devices
    Machine_1: Failed to create user 295
    Machine_10: Connection timeout
```

### 3. Káº¿t quáº£ cuá»‘i cÃ¹ng
```
ğŸ¯ SYNC SUMMARY
Total users found: 200
Users processed: 200
Users successfully synced: 195
Target devices: 2
Success rate: 97.5%
âœ… Most users synced successfully!
```

## âš¡ Hiá»‡u suáº¥t

### ThÃ´ng sá»‘ Ä‘o Ä‘Æ°á»£c:
- **Scan Speed**: ~2.4 users/second Ä‘á»ƒ detect fingerprints
- **Sync Speed**: ~8-10 seconds/user Ä‘á»ƒ sync tá»›i táº¥t cáº£ devices
- **Threading**: Sync Ä‘á»“ng thá»i Ä‘áº¿n tá»‘i Ä‘a 5 devices
- **Success Rate**: ThÆ°á»ng Ä‘áº¡t 85-95% tÃ¹y tÃ¬nh tráº¡ng máº¡ng

### Tá»‘i Æ°u hÃ³a:
- âœ… **Individual finger scanning**: QuÃ©t tá»«ng ngÃ³n tay Ä‘á»ƒ detect chÃ­nh xÃ¡c
- âœ… **Template validation**: Loáº¡i bá» templates rá»—ng hoáº·c khÃ´ng há»£p lá»‡  
- âœ… **Connection pooling**: TÃ¡i sá»­ dá»¥ng káº¿t ná»‘i device
- âœ… **Batch processing**: Xá»­ lÃ½ nhiá»u users cÃ¹ng lÃºc
- âœ… **Error recovery**: Retry logic vÃ  skip users cÃ³ lá»—i

## ğŸ› ï¸ Xá»­ lÃ½ lá»—i

### CÃ¡c lá»—i phá»• biáº¿n:

1. **Device connection failed**
   ```bash
   # Test connectivity trÆ°á»›c
   ./sync_all_from_master_device_to_other_devices.sh test
   ```

2. **User creation failed**
   - ThÆ°á»ng do user_id trÃ¹ng láº·p hoáº·c device memory Ä‘áº§y
   - Script sáº½ delete existing user trÆ°á»›c khi táº¡o má»›i

3. **Template save failed**
   - Kiá»ƒm tra dung lÆ°á»£ng device memory
   - Templates quÃ¡ lá»›n hoáº·c format khÃ´ng Ä‘Ãºng

4. **Network timeout**
   - Äiá»u chá»‰nh timeout trong config
   - Kiá»ƒm tra network stability

### Debug mode:
```bash
# Cháº¡y vá»›i verbose Ä‘á»ƒ xem chi tiáº¿t
./sync_all_from_master_device_to_other_devices.sh -v sync

# Kiá»ƒm tra logs
tail -f logs/sync_master_to_devices.log
tail -f logs/sync_master_to_devices_error.log
```

## ğŸ“‹ Monitoring

### Log files:
- **Main log**: `logs/sync_master_to_devices.log`
- **Error log**: `logs/sync_master_to_devices_error.log`
- **Auto rotation**: Khi file > 50MB

### Commands Ä‘á»ƒ monitor:
```bash
# Xem status
./sync_all_from_master_device_to_other_devices.sh status

# Theo dÃµi logs real-time
tail -f logs/sync_master_to_devices.log

# Kiá»ƒm tra errors
grep "ERROR" logs/sync_master_to_devices.log
```

## ğŸ”’ Báº£o máº­t

### LÆ°u Ã½ quan trá»ng:
- âš ï¸ **Device credentials**: ÄÆ°á»£c lÆ°u trong local_config.py
- âš ï¸ **Fingerprint data**: ÄÆ°á»£c truyá»n qua máº¡ng dÆ°á»›i dáº¡ng base64
- âš ï¸ **Lock mechanism**: Chá»‰ cho phÃ©p 1 process sync cÃ¹ng lÃºc
- âš ï¸ **Access control**: Script cáº§n quyá»n truy cáº­p devices vÃ  ports

### Best practices:
- ğŸ” Báº£o máº­t file config vá»›i sensitive data
- ğŸ” Sá»­ dá»¥ng secure network cho device communication
- ğŸ” Monitor logs Ä‘á»ƒ detect unauthorized access
- ğŸ” Backup fingerprint data trÆ°á»›c khi sync

## ğŸ• Scheduling

### Cron job setup:
```bash
# Edit crontab
crontab -e

# Sync tá»« master device má»—i 2 giá»
0 */2 * * * /path/to/sync_all_from_master_device_to_other_devices.sh

# Sync vÃ o lÃºc 3:00 AM má»—i ngÃ y
0 3 * * * /path/to/sync_all_from_master_device_to_other_devices.sh
```

## ğŸ“ Troubleshooting

### Kiá»ƒm tra káº¿t ná»‘i:
```bash
# Test all devices
./sync_all_from_master_device_to_other_devices.sh test

# Ping devices manually
ping 10.0.1.48  # Master device
ping 10.0.1.41  # Target device
```

### Kiá»ƒm tra dá»¯ liá»‡u:
```python
# Test Python script vá»›i 1 user
python sync_all_from_master_device_to_other_devices.py --limit 1
```

### Performance issues:
- Giáº£m sá»‘ concurrent workers náº¿u network cháº­m
- TÄƒng timeout values trong config
- Kiá»ƒm tra device memory availability
- Monitor CPU/RAM usage during sync

---

**LÆ°u Ã½**: ÄÃ¢y lÃ  sync má»™t chiá»u tá»« Master Device â†’ Target Devices. Äá»ƒ sync tá»« ERPNext â†’ Devices, sá»­ dá»¥ng script khÃ¡c.

**Version**: 1.0  
**Last updated**: 2025-01-19