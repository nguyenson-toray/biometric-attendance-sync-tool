# Sync From Master Device To ERPNext

Äá»“ng bá»™ dá»¯ liá»‡u vÃ¢n tay tá»« thiáº¿t bá»‹ master lÃªn ERPNext, lÆ°u vÃ o custom_fingerprints child table.

## ğŸ“‹ MÃ´ táº£ chá»©c nÄƒng

Há»‡ thá»‘ng nÃ y Ä‘á»c táº¥t cáº£ user vÃ  dá»¯ liá»‡u vÃ¢n tay tá»« thiáº¿t bá»‹ master, tÃ¬m employee tÆ°Æ¡ng á»©ng trong ERPNext theo `attendance_device_id` (chá»‰ Active employees), vÃ  lÆ°u fingerprint templates vÃ o `custom_fingerprints` child table.

### âš¡ TÃ­nh nÄƒng chÃ­nh:
- âœ… **Äá»c tá»« Master Device**: Scan táº¥t cáº£ users vÃ  fingerprints tá»« thiáº¿t bá»‹ master  
- âœ… **ERPNext API Client**: Sá»­ dá»¥ng erpnext_api_client Ä‘á»ƒ chuáº©n hÃ³a API calls
- âœ… **Active Employee Only**: Chá»‰ sync vÃ o employees cÃ³ tráº¡ng thÃ¡i Active
- âœ… **Template Storage**: LÆ°u vÃ o custom_fingerprints child table vá»›i cáº¥u trÃºc chuáº©n
- âœ… **Finger Name Mapping**: Map finger_index thÃ nh finger_name (Left Thumb, Right Index, etc.)
- âœ… **Enhanced Data Validation**: Chá»‰ lÆ°u templates há»£p lá»‡, bá» qua templates rá»—ng hoáº·c khÃ´ng há»£p lá»‡
- âœ… **Progress Tracking**: Hiá»ƒn thá»‹ tiáº¿n Ä‘á»™ vÃ  káº¿t quáº£ chi tiáº¿t
- âœ… **Comprehensive Logging**: Log chi tiáº¿t vá»›i shell script wrapper

## ğŸ—‚ï¸ Files liÃªn quan

```
biometric-attendance-sync-tool/
â”œâ”€â”€ sync_from_master_device_to_erpnext.py        # Core sync script
â”œâ”€â”€ sync_from_master_device_to_erpnext.sh        # Shell script vá»›i logging  
â”œâ”€â”€ erpnext_api_client.py                        # ERPNext API Client
â”œâ”€â”€ sync_from_erpnext_to_device.py              # Script tÃ­ch há»£p (cÃ³ --mode from-device)
â”œâ”€â”€ local_config.py                              # Configuration
â”œâ”€â”€ venv/                                        # Virtual environment (required)
â”‚   â”œâ”€â”€ bin/python                               # Python binary
â”‚   â””â”€â”€ lib/python*/site-packages/               # Installed packages
â””â”€â”€ logs/                                        # Log directory
    â””â”€â”€ sync_from_master_device_to_erpnext/      # Sync-specific log folder
        â”œâ”€â”€ sync_master_device_to_erpnext.log        # Main log
        â””â”€â”€ sync_master_device_to_erpnext_error.log  # Error log
```

## âš™ï¸ Thiáº¿t láº­p mÃ´i trÆ°á»ng

### 1. Táº¡o Virtual Environment (Báº¯t buá»™c)

```bash
# Táº¡o virtual environment
python3 -m venv venv

# KÃ­ch hoáº¡t virtual environment
source venv/bin/activate  # Linux/macOS
# hoáº·c: venv\Scripts\activate  # Windows

# CÃ i Ä‘áº·t cÃ¡c packages cáº§n thiáº¿t
pip install pyzk requests

# Kiá»ƒm tra cÃ i Ä‘áº·t
python -c "import pyzk, requests; print('All packages installed successfully')"
```

### 2. Cáº¥u hÃ¬nh

#### local_config.py
```python
# ERPNext connection
ERPNEXT_URL = "http://10.0.1.21"
ERPNEXT_API_KEY = "your-api-key"
ERPNEXT_API_SECRET = "your-api-secret"

# Master device - nguá»“n dá»¯ liá»‡u vÃ¢n tay
devices_master = {
    'device_id': 'Machine_8',
    'ip': '10.0.1.48',
    'punch_direction': None,
    'clear_from_device_on_fetch': False
}
```

### ERPNext Employee Structure
```
Employee doctype cáº§n cÃ³:
- status: Must be "Active" (chá»‰ sync vÃ o Active employees)
- attendance_device_id: Matching vá»›i user_id trÃªn device
- custom_fingerprints: Child table vá»›i structure:
  * finger_index: 0-9
  * finger_name: Left Thumb, Right Index, etc.
  * template_data: Base64 encoded fingerprint template (skip náº¿u rá»—ng)
  * quality_score: Máº·c Ä‘á»‹nh lÃ  0
```

## ğŸš€ CÃ¡ch sá»­ dá»¥ng

### 1. Shell Script (Khuyáº¿n khÃ­ch)

**LÆ°u Ã½**: Shell script tá»± Ä‘á»™ng sá»­ dá»¥ng virtual environment `./venv`

```bash
# Sync táº¥t cáº£ users tá»« master device lÃªn ERPNext (chá»‰ Active employees)
./sync_from_master_device_to_erpnext.sh

# Sync vá»›i verbose output
./sync_from_master_device_to_erpnext.sh -v

# Sync vá»›i giá»›i háº¡n sá»‘ users (testing)
./sync_from_master_device_to_erpnext.sh --limit 10

# Test connectivity Ä‘áº¿n master device vÃ  ERPNext
./sync_from_master_device_to_erpnext.sh test

# Xem tráº¡ng thÃ¡i sync
./sync_from_master_device_to_erpnext.sh status
```

### 2. Python Script trá»±c tiáº¿p

```bash
# KÃ­ch hoáº¡t virtual environment trÆ°á»›c
source venv/bin/activate

# Sync táº¥t cáº£ users
python sync_from_master_device_to_erpnext.py

# Sync vá»›i giá»›i háº¡n
python sync_from_master_device_to_erpnext.py --limit 5

# Hoáº·c cháº¡y trá»±c tiáº¿p vá»›i venv (khÃ´ng cáº§n activate)
venv/bin/python sync_from_master_device_to_erpnext.py
```

### 3. Script tÃ­ch há»£p

```bash
# Sá»­ dá»¥ng script tÃ­ch há»£p vá»›i mode from-device
python sync_from_erpnext_to_device.py --mode from-device
```

## ğŸ“Š Quy trÃ¬nh xá»­ lÃ½

### 1. Äá»c dá»¯ liá»‡u tá»« Master Device
```
ğŸ” Reading all users from master device...
Master: Machine_8 (10.0.1.48)
ğŸ‘¥ Found 901 total users on master device
  Progress: 0/901
  âœ… 161: Truong Thi My Hoa (4 fingerprints)
  âœ… 295: Nguyen Thi Thuong (2 fingerprints)
ğŸ“Š Found 200+ users with fingerprints
```

### 2. Matching vÃ  lÆ°u vÃ o ERPNext
```
ğŸ“¤ Syncing 200 users to ERPNext...
Progress: 1/200 - 161: Truong Thi My Hoa (4 fingerprints)
  âœ… Synced to ERPNext: TIQN-0161 - Truong Thi My Hoa (4 fingerprints)
Progress: 2/200 - 295: Nguyen Thi Thuong (2 fingerprints)
  âš ï¸ Skipped: No active employee found with attendance_device_id: 295
```

### 3. Káº¿t quáº£ cuá»‘i cÃ¹ng
```
ğŸ¯ SYNC SUMMARY - MASTER DEVICE TO ERPNEXT
Total users found on device: 200
Users processed: 200
Users successfully synced to ERPNext: 150
Users skipped (no matching active employee): 50
Success rate: 75.0%
âš ï¸ Partial success: 150/200 users synced
```

## ğŸ—ƒï¸ Cáº¥u trÃºc dá»¯ liá»‡u ERPNext

### Employee Document
```json
{
  "name": "EMP-0001",
  "employee": "TIQN-0161", 
  "employee_name": "Truong Thi My Hoa",
  "attendance_device_id": "161",
  "custom_fingerprints": [
    {
      "finger_index": 0,
      "finger_name": "Left Thumb",
      "template_data": "base64_encoded_template_data_here",
      "quality_score": 0
    },
    {
      "finger_index": 1,
      "finger_name": "Left Index", 
      "template_data": "base64_encoded_template_data_here",
      "quality_score": 0
    }
  ]
}
```

### Finger Name Mapping
```python
finger_names = {
    0: "Left Thumb",    1: "Left Index",     2: "Left Middle", 
    3: "Left Ring",     4: "Left Little",    5: "Right Thumb",
    6: "Right Index",   7: "Right Middle",   8: "Right Ring", 
    9: "Right Little"
}
```

## âš¡ Hiá»‡u suáº¥t

### ThÃ´ng sá»‘ Ä‘o Ä‘Æ°á»£c:
- **Device Scan Speed**: ~2.4 users/second Ä‘á»ƒ detect fingerprints
- **ERPNext API Speed**: ~3-5 seconds/user Ä‘á»ƒ update employee
- **Success Rate**: 70-85% tÃ¹y sá»‘ lÆ°á»£ng employees cÃ³ attendance_device_id
- **Total Time**: ~45-60 phÃºt cho 200 users

### Bottlenecks:
- ğŸŒ **ERPNext API calls**: Má»—i employee cáº§n 2 API calls (GET + PUT)
- ğŸŒ **Device scanning**: Pháº£i quÃ©t tá»«ng finger (0-9) cho má»—i user
- ğŸŒ **Data validation**: Filter templates rá»—ng vÃ  khÃ´ng há»£p lá»‡

## ğŸ› ï¸ Xá»­ lÃ½ lá»—i

### CÃ¡c lá»—i phá»• biáº¿n:

1. **Virtual environment not found**
   ```
   ERROR Virtual environment not found: ./venv
   ```
   - Táº¡o virtual environment: `python3 -m venv venv`
   - CÃ i packages: `venv/bin/pip install pyzk requests`

2. **Python modules not available**
   ```
   WARN Cannot verify Python modules availability in virtual environment
   ```
   - CÃ i Ä‘áº·t trong venv: `venv/bin/pip install pyzk requests`

3. **No active employee found with attendance_device_id**
   ```
   âš ï¸ Skipped: No active employee found with attendance_device_id: 295
   ```
   - Employee chÆ°a cÃ³ attendance_device_id Ä‘Æ°á»£c set
   - Employee khÃ´ng cÃ³ tráº¡ng thÃ¡i "Active"
   - attendance_device_id khÃ´ng match vá»›i user_id trÃªn device

4. **ERPNext API errors**
   ```bash
   # Test API connection
   ./sync_from_master_device_to_erpnext.sh test
   ```

5. **Device connection failed**
   ```
   âŒ Failed to connect to master device
   ```
   - Kiá»ƒm tra IP vÃ  port cá»§a master device
   - Firewall hoáº·c network issues

6. **Template save errors**
   ```
   Error: Failed to update employee: HTTP 500
   ```
   - ERPNext permissions issues
   - custom_fingerprints table chÆ°a Ä‘Æ°á»£c táº¡o

### Debug mode:
```bash
# Cháº¡y vá»›i verbose Ä‘á»ƒ xem chi tiáº¿t
./sync_from_master_device_to_erpnext.sh -v sync

# Test vá»›i 1 user
./sync_from_master_device_to_erpnext.sh --limit 1 -v sync

# Kiá»ƒm tra logs
tail -f logs/sync_from_master_device_to_erpnext/sync_master_device_to_erpnext.log
```

## ğŸ“‹ ERPNext Setup Requirements

### 1. Custom Fields in Employee Doctype
```
attendance_device_id: Data field
custom_fingerprints: Table field
```

### 2. Child Table: Fingerprint Data
```
finger_index: Int
finger_name: Data  
template_data: Long Text
quality_score: Int
```

### 3. API Permissions
API User cáº§n cÃ³ quyá»n:
- Read Employee
- Write Employee
- Read/Write custom_fingerprints child table

### 4. API Keys
```python
# Táº¡o API Keys trong ERPNext
User â†’ API Access â†’ Generate Keys
ERPNEXT_API_KEY = "generated_key"
ERPNEXT_API_SECRET = "generated_secret"
```

## ğŸ”’ Báº£o máº­t

### LÆ°u Ã½ quan trá»ng:
- âš ï¸ **ERPNext credentials**: API key/secret trong local_config.py  
- âš ï¸ **Fingerprint templates**: Transmitted as base64 over network
- âš ï¸ **Employee data**: PII Ä‘Æ°á»£c truyá»n qua API calls
- âš ï¸ **Data overwrite**: Script sáº½ xÃ³a existing fingerprints vÃ  táº¡o má»›i
- âš ï¸ **Active employees only**: Chá»‰ sync vÃ o employees cÃ³ status="Active"

### Best practices:
- ğŸ” Secure API credentials vÃ  config files
- ğŸ” Use HTTPS for ERPNext API calls
- ğŸ” Backup employee data trÆ°á»›c khi sync
- ğŸ” Monitor API access logs
- ğŸ” Limit API user permissions

## ğŸ“ Troubleshooting

### Kiá»ƒm tra ERPNext connection:
```bash
# Test API connectivity
curl -H "Authorization: token API_KEY:API_SECRET" \
     http://your-erpnext-server/api/method/frappe.auth.get_logged_user
```

### Kiá»ƒm tra Employee data:
```bash
# Kiá»ƒm tra employees cÃ³ attendance_device_id
curl -H "Authorization: token API_KEY:API_SECRET" \
     "http://erpnext/api/resource/Employee?fields=[\"name\",\"attendance_device_id\"]&filters=[[\"attendance_device_id\",\"is\",\"set\"]]"
```

### Performance optimization:
- Batch API calls náº¿u cÃ³ thá»ƒ
- Implement caching cho employee lookups  
- Parallel processing cho multiple employees
- Use database connections thay vÃ¬ API náº¿u cÃ³ thá»ƒ

## ğŸ• Scheduling

### Cron job setup:
```bash
# Sync tá»« device lÃªn ERPNext má»—i 4 giá»
0 */4 * * * /path/to/sync_from_master_device_to_erpnext.sh

# Sync vÃ o lÃºc 4:00 AM má»—i ngÃ y
0 4 * * * /path/to/sync_from_master_device_to_erpnext.sh
```

### Workflow integration:
```
Device Updates â†’ Master Device Sync â†’ ERPNext Update â†’ Notification
```

---

## ğŸ“ Changelog

### Version 1.1 (2025-01-21)
- âœ… **NEW**: Sá»­ dá»¥ng erpnext_api_client thay vÃ¬ requests trá»±c tiáº¿p
- âœ… **NEW**: Chá»‰ sync vÃ o Active employees (status="Active")
- âœ… **NEW**: Logs Ä‘Æ°á»£c lÆ°u vÃ o folder riÃªng `logs/sync_from_master_device_to_erpnext/`
- âœ… **NEW**: Báº¯t buá»™c sá»­ dá»¥ng virtual environment `./venv`
- âœ… **IMPROVED**: Enhanced data validation - skip empty/invalid templates
- âœ… **IMPROVED**: Better error messages vá» active employee requirements
- âœ… **IMPROVED**: API client há»— trá»£ PUT/DELETE methods
- âœ… **IMPROVED**: Shell script tá»± Ä‘á»™ng kiá»ƒm tra vÃ  sá»­ dá»¥ng virtual environment

### Version 1.0 (2025-01-19)
- Initial release vá»›i basic sync functionality

---

**LÆ°u Ã½**: ÄÃ¢y lÃ  sync má»™t chiá»u tá»« Master Device â†’ ERPNext (Active employees only). Äá»ƒ sync ngÆ°á»£c láº¡i tá»« ERPNext â†’ Devices, sá»­ dá»¥ng cÃ¡c modes khÃ¡c.

**Version**: 1.1  
**Last updated**: 2025-01-21